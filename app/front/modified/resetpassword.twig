{% include 'header.twig' %}

<link rel="stylesheet" href="/css/auth-pages.css">

<style>
.reset-steps { display: none; }
.reset-steps.active { display: block; }
.toggle-mode { color: #2F86FA; cursor: pointer; text-decoration: underline; font-size: 14px; }
.toggle-mode:hover { color: #5a9ffc; }
.helper-text { color: #888; font-size: 13px; margin-top: 8px; }
.loading-state { display: none; color: #888; font-size: 14px; padding: 10px 0; }
.loading-state.show { display: flex; align-items: center; gap: 10px; }
.loading-spinner { width: 18px; height: 18px; border: 2px solid #333; border-top-color: #2F86FA; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.code-input { letter-spacing: 8px; font-size: 24px; text-align: center; font-family: monospace; }
.support-link { margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; font-size: 13px; color: #888; }
.support-link a { color: #2F86FA; }
</style>

<div class="auth-page">
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">
          <i class="fas fa-key"></i>
        </div>
        <h1>Reset Your Password</h1>
        <p id="stepDescription">Enter your username or email address below. We'll help you reset your password securely.</p>
      </div>
      
      {% if errorText %}
      <div class="auth-alert auth-alert-error" id="errorAlert">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage">{{ errorText }}</span>
        <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
      </div>
      {% endif %}
      
      {% if successText %}
      <div class="auth-alert auth-alert-success" id="successAlert">
        <i class="fas fa-check-circle"></i>
        <span id="successMessage">{{ successText }}</span>
        <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
      </div>
      {% endif %}

      <div id="step1" class="reset-steps active">
        <form id="resetStep1Form" class="auth-form" method="post" action="/resetpassword">
          <input type="hidden" name="step" value="1">
          <input type="hidden" name="mode" id="inputMode" value="email">
          
          <div class="form-group">
            <label for="user" id="inputLabel">Email Address</label>
            <input type="text" class="form-control" id="user" name="user" placeholder="Enter your email address" required>
          </div>
          
          {% if captcha %}
          <div class="g-recaptcha" data-sitekey="{{ captchaKey }}"></div>
          {% endif %}
          
          <div class="loading-state" id="loading1">
            <div class="loading-spinner"></div>
            <span>Checking account details... please wait</span>
          </div>
          
          <button type="submit" class="btn-submit" id="submitBtn1">Continue</button>
          
          <p style="text-align: center; margin-top: 15px;">
            <span class="toggle-mode" id="toggleMode">Reset using username instead</span>
          </p>
          
          <p class="helper-text">If your account exists, we'll send a verification code to your registered email.</p>
        </form>
      </div>

      <div id="step2" class="reset-steps">
        <form id="resetStep2Form" class="auth-form" method="post" action="/resetpassword">
          <input type="hidden" name="step" value="2">
          <input type="hidden" name="user" id="step2User" value="">
          
          <div class="auth-alert auth-alert-success" style="margin-bottom: 20px;">
            <i class="fas fa-envelope"></i>
            <span>We've sent a verification code to your registered email.</span>
          </div>
          
          <div class="form-group">
            <label for="code">Verification Code</label>
            <input type="text" class="form-control code-input" id="code" name="code" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required>
          </div>
          
          <div class="loading-state" id="loading2">
            <div class="loading-spinner"></div>
            <span>Verifying code... please wait</span>
          </div>
          
          <button type="submit" class="btn-submit">Verify Code</button>
          
          <p class="helper-text">Didn't receive the code? <span class="toggle-mode" id="resendCode">Resend code</span></p>
        </form>
      </div>

      <div id="step3" class="reset-steps">
        <form id="resetStep3Form" class="auth-form" method="post" action="/resetpassword">
          <input type="hidden" name="step" value="3">
          <input type="hidden" name="user" id="step3User" value="">
          <input type="hidden" name="code" id="step3Code" value="">
          
          <div class="auth-alert auth-alert-success" style="margin-bottom: 20px;">
            <i class="fas fa-check-circle"></i>
            <span>Code verified! Create your new password.</span>
          </div>
          
          <div class="form-group">
            <label for="password">New Password</label>
            <input type="password" class="form-control" id="password" name="password" placeholder="Enter new password" required minlength="6">
          </div>
          
          <div class="form-group">
            <label for="password_again">Confirm Password</label>
            <input type="password" class="form-control" id="password_again" name="password_again" placeholder="Confirm new password" required minlength="6">
          </div>
          
          <div class="loading-state" id="loading3">
            <div class="loading-spinner"></div>
            <span>Updating password... please wait</span>
          </div>
          
          <button type="submit" class="btn-submit">Reset Password</button>
        </form>
      </div>
      
      <div class="auth-footer">
        <p>Remember your password? <a href="/auth">Back to Login</a></p>
      </div>
      
      <div class="support-link">
        Still stuck? <a href="/tickets">Contact Support</a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var isUsernameMode = false;
  var toggleMode = document.getElementById('toggleMode');
  var inputLabel = document.getElementById('inputLabel');
  var userInput = document.getElementById('user');
  var inputModeField = document.getElementById('inputMode');
  
  if (toggleMode) {
    toggleMode.addEventListener('click', function() {
      isUsernameMode = !isUsernameMode;
      if (isUsernameMode) {
        inputLabel.textContent = 'Username';
        userInput.placeholder = 'Enter your username';
        toggleMode.textContent = 'Reset using email instead';
        inputModeField.value = 'username';
      } else {
        inputLabel.textContent = 'Email Address';
        userInput.placeholder = 'Enter your email address';
        toggleMode.textContent = 'Reset using username instead';
        inputModeField.value = 'email';
      }
    });
  }
  
  var forms = ['resetStep1Form', 'resetStep2Form', 'resetStep3Form'];
  forms.forEach(function(formId, index) {
    var form = document.getElementById(formId);
    if (form) {
      form.addEventListener('submit', function(e) {
        var loadingEl = document.getElementById('loading' + (index + 1));
        var submitBtn = form.querySelector('button[type="submit"]');
        if (loadingEl) loadingEl.classList.add('show');
        if (submitBtn) submitBtn.disabled = true;
        
        setTimeout(function() {
          if (loadingEl) loadingEl.classList.remove('show');
          if (submitBtn) submitBtn.disabled = false;
        }, 15000);
      });
    }
  });
  
  var resendCode = document.getElementById('resendCode');
  if (resendCode) {
    resendCode.addEventListener('click', function() {
      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.remove('active');
    });
  }
});
</script>

{% include 'footer.twig' %}
